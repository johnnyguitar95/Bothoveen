ep.registerInstance("ep.controller.control.BookRelatedInformationController","ep.base.Controller",(function(p){function l(a){var c=p(a);var d=p(document.createElement("div")).css({height:"50px"}).addClass("loading");var b=document.location.pathname;b=b.substring(0,b.indexOf("/"+ep.interfaceId));b+="/"+ep.interfaceId+"/catalogitem/getbookrelationshipinfo/";b+="?id="+escape(c.attr("data-related-info-uid"));b+="&sid="+p("#__sid").val()+"&vid="+p("#__vid").val();c.before(d).remove();r({url:b,method:"get",dataType:"html",success:function(e){d.css({height:"auto"}).removeClass("loading").html(e)},error:function(){d.removeClass("loading").html(ep.messages.ajax_error)}})}var o={head:null,waiting:[]};function m(){if(!o.waiting.length){o.head=null;return}o.head=o.waiting.shift();p.ajax(o.head)}function r(a){a.originalComplete=a.complete;a.complete=(function(b){return function(c,d){m();if(b.originalComplete){b.originalComplete(c,d)}}})(a);o.waiting.push(a);if(!o.head){m()}}function k(){if(p(".custom-widget.running").length===0){p(".widget-loading").hide()}}function s(){if(p(".custom-widget.running").length>0){p(".widget-loading").show()}}function t(b){var a=p(".collapse-content",b.data);a.css({visibility:"hidden"});var c=a[0].style.height;if(!c&&b.seenExpansion){a.carousel();a.css({visibility:"visible"});p(b.target).unbind("click",t);return}else{b.seenExpansion=true}window.setTimeout(function(){t(b)},50)}function n(a,b){if(!b){return}r({url:b,method:"get",dataType:"html",success:(function(c){return function(h){p(c).removeClass("running");if(!h){p(c).addClass("no-results");p(c).find(".collapse-toggle").data("disableexpandcollapse","true")}else{p('#relatedInfoLinks li[data-key="'+p(c).attr("data-key")+'"]').removeClass("display-none")}if(p(".custom-widget.running").length===0){var g=p("#relatedInfoLinks");g.hide().removeClass("hidden");if(p("li:not(.display-none)",g).length!==0){g.fadeIn()}else{g.fadeOut()}}k();if(!h){return}var e=p(".collapse-content",c)[0];p(e).html(h);var i=parseInt(p(c).find(".widget_min_display_criteria").val(),10);if(p(c).find(".widget_item_count").length>0){var d=parseInt(p(c).find(".widget_item_count").val(),10);if(d>0&&d>=i){p(c).show()}else{p('#relatedInfoLinks li[data-key="'+p(c).attr("data-key")+'"]').hide()}}else{p(c).show()}if(p(".carousel",e).length){ep.require("_layout"+ep.cssLayout+"/bookcarousel.css");ep.require("_layout"+ep.cssLayout+"/carousel.css");ep.require("ep/controller/control/carousel.js");p(".custom-widget-header",c).bind("click",c,t)}if(p(".catalogItemList",e)){p(e).css({textAlign:"left"});p(".preview-hover",e).each(function(){ep.dialog.RecordPreview.addSelfContainedRecordPreview(this,570)})}var f=p("a.restricted",e);if(f.length&&ep.controller.GuestLoginController){ep.controller.GuestLoginController.addRestrictions(f)}}})(a),error:(function(c){return function(){p(c).removeClass("running");p(".collapse-content",c).html(ep.messages.ajax_error);k()}})(a)})}var q={onDomLoad:function(){var a=p(".bookRelatedInformationPlaceHolder");if(a.length){l(a[0])}s();p(".custom-widget.running").each(function(){n(this,p(".ajax_url",this).val())});p("#content").delegate(".close","click",function(b){p(b.target).closest(".custom-widget").hide()})}};return q})(jQuery));